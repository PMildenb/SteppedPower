---
title: "`SteppedPower`, an `R`-package"
author: "Philipp Mildenberger"
date: "4 December 2018"
output: slidy_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message=FALSE)
```

## What?

* `SteppedPower` calculates power for longitudinal intervention studies
* offers tools for visualization of cluster influences
* applicable to various designs:
    + stepped wedge
    + parallel
    + parallel with baseline
    + t.b.c. 



## Why?

Software for power calculation of SWD already exists (in R: `swCRTdesign`, `SWSamp`;  in Stata: `steppedwedge`).
So why yet another power package?

* `SteppedPower` can handle unequal cluster sizes
* constructs exact covariance matrix for non-normal responses
* convenient option to compare power of a SWD to other designs 
* focuses on choice of appropriate design 

## How?

Calculate power of a z-test 

$$ \text{power} = \Phi\left(\frac{\theta_A-\theta_0}{\sqrt{\text{Var}(\hat \theta)}}- Z_{1-\frac{\alpha}{2}}\right) $$ 


where $\text{Var}(\hat \theta)$ depends on the **design matrix** and the **covariance matrix**.
  

## Design Matrix
* one row per observation
* one column per variable

```{r}
SteppedPower::construct_DesMat(Cl=c(1,1), design="SWD")
SteppedPower::construct_DesMat(Cl=c(1,1), design="parallel", timepoints=3)
```

## Covariance Matrix
* one block of dim timepoints$^2$ per cluster
```{r}
SteppedPower::construct_CovBlk(timepoints=3, sigma=0.5, tau=0.1)
SteppedPower:::construct_CovMat(SumCl=2, timepoints=3, sigma=c(0.5,1), tau=0.1)
```

## Main function
call the function `wlsMixedPower`
```{r}
library(SteppedPower)
wlsMixed_swd <- wlsMixedPower(EffSize=2, sigma=1, tau=0.1, 
                              N=c(4,1), Cl=c(1,1), design="SWD")
wlsMixed_swd$Power
```

* N denotes the sizes of the two clusters, sigma is adjusted for:
```{r}
wlsMixed_swd$CovarianceMatrix

wlsMixed_swd$DesignMatrix
```

## Visualization - Weight Matrix
```{r}
plot_swd <- plot_wlsPower(wlsMixed_swd)
plot_swd[[1]]
```

* first and third period have (almost) no effect on trt estimate (!)
* power quite low 

```{r}
wlsMixed_parll <- wlsMixedPower(EffSize=2, sigma=1, tau=0.1, 
                                N=c(4,1), Cl=c(1,1), design="parallel",timepoints=3)
plot_wlsPower(wlsMixed_parll)[[1]]

wlsMixed_parll$Power
```

## Weight Matrix - high cluster correlation 


```{r}
wlsMixed_swd2 <- wlsMixedPower(EffSize=2, sigma=1, tau=1, 
                                N=c(4,1), Cl=c(1,1), design="SWD")
plot_wlsPower(wlsMixed_swd2)[[1]]

wlsMixed_swd2$Power
```


```{r}
wlsMixed_parll2 <- wlsMixedPower(EffSize=2, sigma=1, tau=1, 
                                N=c(4,1), Cl=c(1,1), design="parallel",timepoints=3)
plot_wlsPower(wlsMixed_parll2)[[1]]

wlsMixed_parll2$Power
```


## 4 Clusters
```{r}
wlsMixed_4swd <- wlsMixedPower(EffSize=1.5, sigma=1, tau=0.1, 
                                N=1, Cl=c(1,1,1,1), design="SWD")
plot_wlsPower(wlsMixed_4swd)[[1]]
wlsMixed_4swd$Power


wlsMixed_4parll <- wlsMixedPower(EffSize=1.5, sigma=1, tau=0.1, 
                                N=1, Cl=c(2,2), design="parallel",timepoints=5)
plot_wlsPower(wlsMixed_4parll)[[1]]
wlsMixed_4parll$Power
```


## compairing designs
function `compare_designs` returns power for three settings with different designs, but the same 
number of clusters and observation periods
```{r}
compare_designs(EffSize=1.5, sigma=1 ,tau=.1, Cl=c(1,1,1,1))
compare_designs(EffSize=1.5, sigma=1 ,tau= 1, Cl=c(1,1,1,1))
```


## Cluster Weigths ( Setting with 100 Clusters)
```{r}
swd100 <- wlsMixedPower(EffSize=0.1,sigma=1,tau=.15,Cl=rep(2,50))
```

### Plot of  
* weight matrix, 
* absolute cluster weights, 
* ablolute period weights
```{r,echo=FALSE}
plot_wlsPower(swd100)[[1]]
plot_wlsPower(swd100)[[2]]
plot_wlsPower(swd100)[[3]]
```

### Power comparison
```{r}
compare_designs(EffSize=0.1,sigma=1,tau=.15,Cl=rep(2,50))
```


## Prospects 

```{r, echo= FALSE}
# download.file("http://simonsoftware.se/other/xkcd.ttf", dest="xkcd.ttf", mode="wb")
# system("mkdir ~/.fonts") 
# system("cp xkcd.ttf ~/.fonts") 
# font_import(pattern = "[X/x]kcd", prompt=FALSE) 
# fonts() 
# fonttable() 
# if(.Platform$OS.type != "unix") { 
# ## Register fonts for Windows bitmap output 
#   loadfonts(device="win")
# } else {  
#   loadfonts() 
# }
# 
# p <- ggplot() + geom_point(aes(mpg, wt), data=mtcars) +
#     theme_xkcd()
# p
# 
# xrange <- range(mtcars$mpg)
# yrange <- range(mtcars$wt)
# p <- ggplot() +
#      geom_point(aes(mpg, wt), data=mtcars) +
#      xkcdaxis(xrange,yrange)
# p


# datascaled <- data.frame(x=c(-3,3),y=c(-30,30))
# p <- ggplot(data=datascaled, aes(x=x,y=y)) + geom_point()
# xrange <- range(datascaled$x)
# yrange <- range(datascaled$y)
# ratioxy <- diff(xrange) / diff(yrange)

# mapping <- aes(x=x,
#                y=y,
#                scale=scale,
#                ratioxy=ratioxy,
#                angleofspine = angleofspine,
#                anglerighthumerus = anglerighthumerus,
#                anglelefthumerus = anglelefthumerus,
#                anglerightradius = anglerightradius,
#                angleleftradius = angleleftradius,
#                anglerightleg =  anglerightleg,
#                angleleftleg = angleleftleg,
#                angleofneck = angleofneck,
#                color = color )
#  
# dataman <- data.frame( x= c(-1,0,1), y=c(-10,0,10),
#                   scale = c(10,7,5),
#                   ratioxy = ratioxy,
#                   angleofspine =  seq(- pi / 2, -pi/2 + pi/8, l=3) ,
#                   anglerighthumerus = -pi/6,
#                   anglelefthumerus = pi + pi/6,
#                   anglerightradius = 0,
#                   angleleftradius = runif(3,- pi/4, pi/4),
#                   angleleftleg = 3*pi/2  + pi / 12 ,
#                   anglerightleg = 3*pi/2  - pi / 12,
#                   angleofneck = runif(3, min = 3 * pi / 2 - pi/10 , max = 3 * pi / 2 + pi/10),
#                   color=c("A","B","C"))
#  
# p + xkcdman(mapping,dataman)


library(xkcd)


iswd <- c("add incomplete SWD",2,1)
mswd <- c("add mixture designs",1,2.5)
iviz <- c("improve visualizations",-.2,.5)
nviz <- c("visualize sensitivity \n to misspecification",1,3.5)
ncov <- c("AR-m correlation structure",2,2.3)
ntau <- c("random intervention effect",3,-.3)
bugs <- c("find all bugs",2.5,4)
doku <- c("document my code",3.3,2)
iccs <- c("icc as input option \n for cluster effect",-1,-1)
coun <- c("implement count responses",0,-.5)
soun <- c("add sound effects",0,-1.5)
clgr <- c("randomizig clusters \n of different sizes",1,-1.2)


dat <- as.data.frame(rbind(iswd,mswd,iviz,nviz,ncov,ntau,bugs,doku,iccs,coun,
                           soun,clgr))
names(dat) <- c("proj","importance","difficulty")
dat$importance <- as.numeric(as.character(dat$importance))
dat$difficulty <- as.numeric(as.character(dat$difficulty))

p1 <- ggplot(dat, aes(importance, difficulty)) 
# + xlim(-2.3,4) + ylim(-2.3,4)
#p1 <- p1 + scale_y_continuous(breaks=c(-1,0,3),labels=c("easy","sunday afternoon","eehm .. Jochem??"))
#p1
p1 + geom_text(family="xkcd",aes(label=proj)) + xkcdaxis(c(-1.5,4),c(-2.3,4))
# p1 + theme_xkcd()+ geom_text(family="xkcd",aes(label=proj))
```

<!-- ... a lot. -->


<!-- * add 'edge cases' of SWD, e.g. incomplete designs -->
<!-- * add mixtures of SWD and parallel designs -->
<!-- * improve existing visualizations -->
<!-- * find (and implement) visualizations for the sensitivity to misspecification -->
<!-- * ...  -->



current state of the package     `devtools::install.github("PMildenb/SteppedPower")`
