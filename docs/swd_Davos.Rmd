---
title: "swd_Davos"
author: "Philipp Mildenberger"
date: "10 Januar 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(swCRTdesign)
library(beepr)
library(lme4)
library(SteppedPower)
set.seed(42^2)
```

# Aufgabenstellung v Jochem:

Lieber Philipp,

Kannst du mal für dieses Design die tatsächliche Power finden?
Für eine Analyseart deiner Wahl, die das alpha=0.05 hält.


```{r}
swPwr(swDsn(c(3,4,3)), distn="binomial", 
        n=38, mu0=0.33, mu1=0.22, tau=0.04, eta=0, rho=0, alpha=0.05, retDATA=FALSE)
```


# Power mit unterschiedlichern Varianzen zwischen Kontrolle/Intervention

```{r}
wlsGlmmPower(Cl=c(3,4,3),mu0=0.33,mu1=0.22,tau=0.04,N=38,verbose=F)
```
Dabei ist der zufэllige Clustereffekt als normalverteilt aus dem linearen Prädiktor interpretiert,
dadurch ist tau unter Kontrolle und unter Intervention gleich.

# Designvergleiche
```{r}
wlsGlmmPower(Cl=c(3,4,3),mu0=.33,mu1=,.22,tau=0.04,eta=0,rho=0,
             family="binomial",N=38,verbose=T)
wlsGlmmPower(Cl=c(5,5),mu0=.33,mu1=,.22,tau=0.04,eta=0,rho=0,
             family="binomial",N=38,verbose=F,design="parallel",timepoints=4)
wlsGlmmPower(Cl=c(5,5),mu0=.33,mu1=,.22,tau=0.04,eta=0,rho=0,
             family="binomial",N=38,verbose=F,design="parallel_baseline",timepoints=4)


```



# Simulation

Ich simuliere das mit momentan mit normalverteiltem Fehler auf der erwarteten Proportion (grob nach swSim)

### der Power
```{r}
power <- as.data.frame(mapply(realpower.simulate,1:1000,
                MoreArgs=list(nInd=38,mu0=0.33,mu1=.22,tau=.0,design=swDsn(c(3,4,3)),whichModel=c("AGQ","PQL"))))

dim(power)
mean(power[1,]<0.05)
mean(power[2,]<0.05)
mean(power[3,]<0.05)

for(i in 1:10){print(i);beep();Sys.sleep(.5)}

qqnorm(power["tx.est.PQL",])
qqnorm(power["tx.est.AGQ",])
```

### des \alpha-Fehlers

Hier ist $\mu_1=\mu_0=0.33$
```{r}
error <- as.data.frame(mapply(realpower.simulate,1:500,
                MoreArgs=list(nInd=38,mu0=0.33,mu1=.33,tau=.0,design=swDsn(c(3,4,3)),
                              whichModel=c("AGQ","PQL","GEE"))))

dim(error)
mean(error[1,]<0.05)
mean(error[2,]<0.05)
mean(error[3,]<0.05)

for(i in 1:5){print(i);beep();Sys.sleep(.5)}

qqnorm(error["tx.est.PQL",])
qqnorm(error["tx.est.AGQ",])

qqplot(qunif(ppoints(1000),p=.05), error["p.ztest.AGQ",])
qqplot(qunif(ppoints(1000),p=.05), error["p.ttest.PQL",])

```

