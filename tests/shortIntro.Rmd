---
title: "about SteppedPower"
author: "Philipp Mildenberger"
date: "4 December 2018"
output: slidy_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## What?

* `SteppedPower` calculates power for longitudinal intervention studies
* offers tools for visualization of cluster influences
* applicable to various designs:
    + stepped wedge
    + parallel
    + parallel with baseline
    + t.b.c. 



## Why?

Software for power calculation of SWD already exists (in R: `swCRTdesign`, `SWSamp`;  in Stata: `steppedwedge`).
So why yet another new package?

* 
* constructs exact covariance matrix for non-normal responses
* convenient option to compare power of a SWD to other designs 
* integrates 

## How?

Calculate power of a z-test 

$$ \text{power} = \Phi\left(\frac{\theta_A-\theta_0}{\sqrt{\text{Var}(\hat \theta)}}- Z_{1-\frac{\alpha}{2}}\right) $$ 


where $\text{Var}(\hat \theta)$ depends on the design matrix and the covariance matrix.

## Design Matrix

```{r}
library(SteppedPower)
SteppedPower::construct_DesMat(Cl=c(1,1), design="SWD")
SteppedPower::construct_DesMat(Cl=c(1,1), design="parallel", timepoints=3)
```

## Covariance Matrix

```{r}
SteppedPower::construct_CovBlk(timepoints=3, sigma=0.5, tau=0.1)
SteppedPower:::construct_CovMat(SumCl=2, timepoints=3, sigma=c(0.5,1), tau=0.1)
```

## Main function
call the function `wlsMixedPower`
```{r}
wlsMixed_swd <- wlsMixedPower(EffSize=2, sigma=1, tau=0.1, 
                              N=c(4,1), Cl=c(1,1), design="SWD")
wlsMixed_swd$Power
```

* N denotes the sizes of the two clusters, sigma is adjusted for:
```{r}
wlsMixed_swd$CovarianceMatrix
```


## Main function
```{r}
wlsMixed_swd$DesignMatrix
```

## Visualizations
```{r}
plot_swd <- plot_wlsPower(wlsMixed_swd)
plot_swd[[1]]
```

* first and third period have (almost) no effect on trt estimate (!)

```{r}
wlsMixed_swd2 <- wlsMixedPower(EffSize=2, sigma=1, tau=1, 
                              N=c(4,1), Cl=c(1,1), design="SWD")
plot_swd2 <- plot_wlsPower(wlsMixed_swd2)
plot_swd2[[1]]
```

## Main function, revisited
```{r}
wlsMixed_parll <- wlsMixedPower(EffSize=2, sigma=1, tau=0.1, 
                                N=c(4,1), Cl=c(1,1), design="parallel",timepoints=3)
plot_wlsPower(wlsMixed_parll)[[1]]

wlsMixed_parll$Power
```




## TODO

```{r}
# download.file("http://simonsoftware.se/other/xkcd.ttf", dest="xkcd.ttf", mode="wb")
# system("mkdir ~/.fonts") 
# system("cp xkcd.ttf ~/.fonts") 
# font_import(pattern = "[X/x]kcd", prompt=FALSE) 
# fonts() 
# fonttable() 
# if(.Platform$OS.type != "unix") { 
# ## Register fonts for Windows bitmap output 
#   loadfonts(device="win")
# } else {  
#   loadfonts() 
# }
# 
# p <- ggplot() + geom_point(aes(mpg, wt), data=mtcars) +
#     theme_xkcd()
# p


library(xkcd)

iswd <- c("add incomplete SWD",2,1)
mswd <- c("add mixture designs",1,2.5)
iviz <- c("improve visualizations",-.2,.5)
nviz <- c("visualize misspecification \n sensitivity",1,3.5)
ncov <- c("AR-m correlation structure",2,2.3)
ntau <- c("random intervention effect",3,-.3)
bugs <- c("erase all bugs",2.5,4)
doku <- c("document my code",3.3,2)
iccs <- c("implement more ways to specify \n cluster correlations",-1,-1)
coun <- c("implement count responses",0,-.5)


dat <- as.data.frame(rbind(iswd,mswd,iviz,nviz,ncov,ntau,bugs,doku,iccs,coun))
names(dat) <- c("proj","importance","difficulty")
dat$importance <- as.numeric(as.character(dat$importance))
dat$difficulty <- as.numeric(as.character(dat$difficulty))

p <- ggplot(dat, aes(importance, difficulty, label = proj)) + xlim(-3,4) + ylim(-3,4)
p + geom_text(family="xkcd") + theme_xkcd() + theme(axis.text.x=element_text())
```

... a lot.


* add 'edge cases' of SWD, e.g. incomplete designs
* add mixtures of SWD and parallel designs
* improve existing visualizations
* find (and implement) visualizations for the sensitivity to misspecification
* ... 


## 

`devtools::install.github()
